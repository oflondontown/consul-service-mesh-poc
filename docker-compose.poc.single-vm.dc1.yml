#
# dc1-only add-on for `docker-compose.poc.single-vm.yml`
# (Adds the demo `itch-consumer` sidecar.)
#
services:
  itch-consumer-envoy-bootstrap:
    image: ${CONSUL_IMAGE:-docker.io/hashicorp/consul:1.17}
    depends_on:
      - consul-config
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      CONSUL_GRPC_ADDR: http://consul:8502
      CONSUL_DATACENTER: ${CONSUL_DATACENTER:-dc1}
      SERVICE_ID: itch-consumer-${CONSUL_DATACENTER}
      ENVOY_ADMIN_BIND: 0.0.0.0:29004
    volumes:
      - itch-consumer-envoy-bootstrap:/bootstrap
    command:
      - sh
      - -ec
      - |
        echo "Waiting for Consul..."
        for i in $(seq 1 90); do consul info >/dev/null 2>&1 && break; sleep 1; done
        echo "Waiting for service registration (${SERVICE_ID})..."
        for i in $(seq 1 180); do wget -qO- "http://consul:8500/v1/agent/service/${SERVICE_ID}" >/dev/null 2>&1 && break; sleep 1; done
        wget -qO- "http://consul:8500/v1/agent/service/${SERVICE_ID}" >/dev/null

        echo "Generating Envoy bootstrap for ${SERVICE_ID}..."
        consul connect envoy -sidecar-for "${SERVICE_ID}" -admin-bind "${ENVOY_ADMIN_BIND}" -bootstrap >/bootstrap/bootstrap.json

  itch-consumer-envoy:
    image: ${ENVOY_IMAGE:-docker.io/envoyproxy/envoy:v1.29-latest}
    restart: unless-stopped
    depends_on:
      - itch-consumer-envoy-bootstrap
    volumes:
      - itch-consumer-envoy-bootstrap:/bootstrap:ro
    command:
      - sh
      - -ec
      - |
        echo "Waiting for bootstrap..."
        for i in $(seq 1 120); do [ -s /bootstrap/bootstrap.json ] && break; sleep 1; done
        test -s /bootstrap/bootstrap.json
        exec envoy -c /bootstrap/bootstrap.json ${ENVOY_EXTRA_ARGS:-}
    ports:
      - "127.0.0.1:19100:19100"
      - "21004:21004"
      - "127.0.0.1:29004:29004"
    networks: [mesh]

volumes:
  itch-consumer-envoy-bootstrap:
