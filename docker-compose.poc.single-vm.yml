#
# Single-VM POC mesh stack (apps run on the VM)
# - Runs Consul server + mesh gateway + Envoy sidecars in containers on this VM.
# - Does NOT run the application processes themselves (webservice/ordermanager/refdata/etc).
#
services:
  consul:
    image: ${CONSUL_IMAGE:-docker.io/hashicorp/consul:1.17}
    restart: unless-stopped
    environment:
      CONSUL_DATACENTER: ${CONSUL_DATACENTER:-dc1}
      CONSUL_NODE_NAME: ${CONSUL_NODE_NAME:-consul-${CONSUL_DATACENTER}}

      # Required: VM IP reachable by this host and the other datacenter.
      # Used for: health check targets, Consul advertise addresses, mesh gateway WAN address.
      HOST_IP: ${HOST_IP:-}

      CONSUL_BOOTSTRAP_EXPECT: ${CONSUL_BOOTSTRAP_EXPECT:-1}
      CONSUL_BIND_ADDR: ${CONSUL_BIND_ADDR:-}
      CONSUL_ADVERTISE_ADDR: ${CONSUL_ADVERTISE_ADDR:-}
      CONSUL_ADVERTISE_WAN_ADDR: ${CONSUL_ADVERTISE_WAN_ADDR:-}
      CONSUL_RETRY_JOIN: ${CONSUL_RETRY_JOIN:-}
      CONSUL_RETRY_JOIN_WAN: ${CONSUL_RETRY_JOIN_WAN:-}
      CONSUL_ENABLE_UI: ${CONSUL_ENABLE_UI:-1}
      CONSUL_ENCRYPT: ${CONSUL_ENCRYPT:-}
    volumes:
      - ./docker/consul/client.hcl:/consul/config/client.hcl:ro
      - ./docker/consul/services-vmhost/${CONSUL_DATACENTER:-dc1}:/consul/config/templates:ro
      - consul-data:/consul/data
    command:
      - sh
      - -ec
      - |
        if [ -z "${HOST_IP:-}" ]; then
          echo "Missing HOST_IP (example: 10.0.0.10)" >&2
          exit 2
        fi

        echo "Rendering service definitions for HOST_IP=${HOST_IP}..."
        mkdir -p /consul/config/rendered
        for f in /consul/config/templates/*.json; do
          name="$(basename "$f")"
          sed "s/__HOST_IP__/${HOST_IP}/g" "$f" >"/consul/config/rendered/$name"
        done

        args="agent -config-file=/consul/config/client.hcl -data-dir=/consul/data"
        args="$args -server -bootstrap-expect=${CONSUL_BOOTSTRAP_EXPECT}"
        args="$args -node=${CONSUL_NODE_NAME} -datacenter=${CONSUL_DATACENTER} -client=0.0.0.0"
        args="$args -config-dir=/consul/config/rendered"

        if [ "${CONSUL_ENABLE_UI:-0}" = "1" ]; then
          args="$args -ui"
        fi

        if [ -n "${CONSUL_BIND_ADDR:-}" ]; then
          args="$args -bind=${CONSUL_BIND_ADDR}"
        fi

        advertise="${CONSUL_ADVERTISE_ADDR:-${HOST_IP}}"
        advertise_wan="${CONSUL_ADVERTISE_WAN_ADDR:-${HOST_IP}}"
        args="$args -advertise=${advertise} -advertise-wan=${advertise_wan}"

        if [ -n "${CONSUL_ENCRYPT:-}" ]; then
          args="$args -encrypt=${CONSUL_ENCRYPT}"
        fi

        for addr in $(echo "${CONSUL_RETRY_JOIN:-}" | tr ',' ' '); do
          [ -n "$addr" ] && args="$args -retry-join=$addr"
        done
        for addr in $(echo "${CONSUL_RETRY_JOIN_WAN:-}" | tr ',' ' '); do
          [ -n "$addr" ] && args="$args -retry-join-wan=$addr"
        done

        echo "Starting: consul $args"
        exec consul $args
    ports:
      - "127.0.0.1:8500:8500"
      - "127.0.0.1:8502:8502"
      - "8300:8300"
      - "8301:8301"
      - "8301:8301/udp"
      - "8302:8302"
      - "8302:8302/udp"
    healthcheck:
      test: ["CMD", "sh", "-ec", "wget -qO- http://127.0.0.1:8500/v1/status/leader | grep -q '8300'"]
      interval: 5s
      timeout: 3s
      retries: 60
    networks: [mesh]

  consul-config:
    image: ${CONSUL_IMAGE:-docker.io/hashicorp/consul:1.17}
    depends_on:
      - consul
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      CONSUL_DATACENTER: ${CONSUL_DATACENTER:-dc1}
    volumes:
      - ./docker/consul/config-entries:/config-entries:ro
    command:
      - sh
      - -ec
      - |
        echo "Waiting for Consul HTTP..."
        for i in $(seq 1 90); do
          wget -qO- http://consul:8500/v1/status/leader | grep -q '8300' && break
          sleep 1
        done

        echo "Writing config entries to ${CONSUL_DATACENTER}..."
        consul config write -datacenter="${CONSUL_DATACENTER}" /config-entries/proxy-defaults.hcl
        consul config write -datacenter="${CONSUL_DATACENTER}" /config-entries/service-defaults.hcl
        consul config write -datacenter="${CONSUL_DATACENTER}" /config-entries/intentions.hcl
        consul config write -datacenter="${CONSUL_DATACENTER}" "/config-entries/refdata-resolver-${CONSUL_DATACENTER}.hcl"
        consul config write -datacenter="${CONSUL_DATACENTER}" "/config-entries/ordermanager-resolver-${CONSUL_DATACENTER}.hcl"
        consul config write -datacenter="${CONSUL_DATACENTER}" "/config-entries/itch-feed-resolver-${CONSUL_DATACENTER}.hcl"
        echo "Done."
    networks: [mesh]

  mesh-gateway-bootstrap:
    image: ${CONSUL_IMAGE:-docker.io/hashicorp/consul:1.17}
    depends_on:
      - consul-config
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      CONSUL_GRPC_ADDR: http://consul:8502
      CONSUL_DATACENTER: ${CONSUL_DATACENTER:-dc1}
      HOST_IP: ${HOST_IP:-}
      ENVOY_ADMIN_BIND: 0.0.0.0:29100
    volumes:
      - mesh-gateway-bootstrap:/bootstrap
    command:
      - sh
      - -ec
      - |
        if [ -z "${HOST_IP:-}" ]; then
          echo "Missing HOST_IP (used for mesh gateway -wan-address)" >&2
          exit 2
        fi

        echo "Waiting for local Consul..."
        for i in $(seq 1 90); do consul info >/dev/null 2>&1 && break; sleep 1; done

        echo "Generating mesh gateway bootstrap..."
        consul connect envoy -gateway=mesh -register \
          -service "mesh-gateway" \
          -address '{{ GetInterfaceIP "eth0" }}:8443' \
          -wan-address "${HOST_IP}:8443" \
          -admin-bind "${ENVOY_ADMIN_BIND}" \
          -bootstrap >/bootstrap/bootstrap.json

  mesh-gateway:
    image: ${ENVOY_IMAGE:-docker.io/envoyproxy/envoy:v1.29-latest}
    depends_on:
      - mesh-gateway-bootstrap
    restart: unless-stopped
    volumes:
      - mesh-gateway-bootstrap:/bootstrap:ro
    command:
      - sh
      - -ec
      - |
        echo "Waiting for bootstrap..."
        for i in $(seq 1 120); do [ -s /bootstrap/bootstrap.json ] && break; sleep 1; done
        test -s /bootstrap/bootstrap.json
        exec envoy -c /bootstrap/bootstrap.json ${ENVOY_EXTRA_ARGS:-}
    ports:
      - "8443:8443"
      - "127.0.0.1:29100:29100"
    networks: [mesh]

  webservice-envoy-bootstrap:
    image: ${CONSUL_IMAGE:-docker.io/hashicorp/consul:1.17}
    depends_on:
      - consul-config
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      CONSUL_GRPC_ADDR: http://consul:8502
      CONSUL_DATACENTER: ${CONSUL_DATACENTER:-dc1}
      SERVICE_ID: webservice-${CONSUL_DATACENTER}
      ENVOY_ADMIN_BIND: 0.0.0.0:29000
    volumes:
      - webservice-envoy-bootstrap:/bootstrap
    command:
      - sh
      - -ec
      - |
        echo "Waiting for Consul..."
        for i in $(seq 1 90); do consul info >/dev/null 2>&1 && break; sleep 1; done
        echo "Waiting for service registration (${SERVICE_ID})..."
        for i in $(seq 1 180); do wget -qO- "http://consul:8500/v1/agent/service/${SERVICE_ID}" >/dev/null 2>&1 && break; sleep 1; done
        echo "Generating Envoy bootstrap for ${SERVICE_ID}..."
        consul connect envoy -sidecar-for "${SERVICE_ID}" -admin-bind "${ENVOY_ADMIN_BIND}" -bootstrap >/bootstrap/bootstrap.json

  webservice-envoy:
    image: ${ENVOY_IMAGE:-docker.io/envoyproxy/envoy:v1.29-latest}
    depends_on:
      - webservice-envoy-bootstrap
    restart: unless-stopped
    volumes:
      - webservice-envoy-bootstrap:/bootstrap:ro
    command:
      - sh
      - -ec
      - |
        echo "Waiting for bootstrap..."
        for i in $(seq 1 120); do [ -s /bootstrap/bootstrap.json ] && break; sleep 1; done
        test -s /bootstrap/bootstrap.json
        exec envoy -c /bootstrap/bootstrap.json ${ENVOY_EXTRA_ARGS:-}
    ports:
      - "127.0.0.1:18082:18082"
      - "127.0.0.1:18083:18083"
      - "21000:21000"
      - "127.0.0.1:29000:29000"
    networks: [mesh]

  ordermanager-envoy-bootstrap:
    image: ${CONSUL_IMAGE:-docker.io/hashicorp/consul:1.17}
    depends_on:
      - consul-config
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      CONSUL_GRPC_ADDR: http://consul:8502
      CONSUL_DATACENTER: ${CONSUL_DATACENTER:-dc1}
      SERVICE_ID: ordermanager-${CONSUL_DATACENTER}
      ENVOY_ADMIN_BIND: 0.0.0.0:29001
    volumes:
      - ordermanager-envoy-bootstrap:/bootstrap
    command:
      - sh
      - -ec
      - |
        echo "Waiting for Consul..."
        for i in $(seq 1 90); do consul info >/dev/null 2>&1 && break; sleep 1; done
        echo "Waiting for service registration (${SERVICE_ID})..."
        for i in $(seq 1 180); do wget -qO- "http://consul:8500/v1/agent/service/${SERVICE_ID}" >/dev/null 2>&1 && break; sleep 1; done
        echo "Generating Envoy bootstrap for ${SERVICE_ID}..."
        consul connect envoy -sidecar-for "${SERVICE_ID}" -admin-bind "${ENVOY_ADMIN_BIND}" -bootstrap >/bootstrap/bootstrap.json

  ordermanager-envoy:
    image: ${ENVOY_IMAGE:-docker.io/envoyproxy/envoy:v1.29-latest}
    depends_on:
      - ordermanager-envoy-bootstrap
    restart: unless-stopped
    volumes:
      - ordermanager-envoy-bootstrap:/bootstrap:ro
    command:
      - sh
      - -ec
      - |
        echo "Waiting for bootstrap..."
        for i in $(seq 1 120); do [ -s /bootstrap/bootstrap.json ] && break; sleep 1; done
        test -s /bootstrap/bootstrap.json
        exec envoy -c /bootstrap/bootstrap.json ${ENVOY_EXTRA_ARGS:-}
    ports:
      - "127.0.0.1:18182:18182"
      - "21001:21001"
      - "127.0.0.1:29001:29001"
    networks: [mesh]

  refdata-envoy-bootstrap:
    image: ${CONSUL_IMAGE:-docker.io/hashicorp/consul:1.17}
    depends_on:
      - consul-config
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      CONSUL_GRPC_ADDR: http://consul:8502
      CONSUL_DATACENTER: ${CONSUL_DATACENTER:-dc1}
      SERVICE_ID: refdata-${CONSUL_DATACENTER}
      ENVOY_ADMIN_BIND: 0.0.0.0:29002
    volumes:
      - refdata-envoy-bootstrap:/bootstrap
    command:
      - sh
      - -ec
      - |
        echo "Waiting for Consul..."
        for i in $(seq 1 90); do consul info >/dev/null 2>&1 && break; sleep 1; done
        echo "Waiting for service registration (${SERVICE_ID})..."
        for i in $(seq 1 180); do wget -qO- "http://consul:8500/v1/agent/service/${SERVICE_ID}" >/dev/null 2>&1 && break; sleep 1; done
        echo "Generating Envoy bootstrap for ${SERVICE_ID}..."
        consul connect envoy -sidecar-for "${SERVICE_ID}" -admin-bind "${ENVOY_ADMIN_BIND}" -bootstrap >/bootstrap/bootstrap.json

  refdata-envoy:
    image: ${ENVOY_IMAGE:-docker.io/envoyproxy/envoy:v1.29-latest}
    depends_on:
      - refdata-envoy-bootstrap
    restart: unless-stopped
    volumes:
      - refdata-envoy-bootstrap:/bootstrap:ro
    command:
      - sh
      - -ec
      - |
        echo "Waiting for bootstrap..."
        for i in $(seq 1 120); do [ -s /bootstrap/bootstrap.json ] && break; sleep 1; done
        test -s /bootstrap/bootstrap.json
        exec envoy -c /bootstrap/bootstrap.json ${ENVOY_EXTRA_ARGS:-}
    ports:
      - "21002:21002"
      - "127.0.0.1:29002:29002"
    networks: [mesh]

  itch-feed-envoy-bootstrap:
    image: ${CONSUL_IMAGE:-docker.io/hashicorp/consul:1.17}
    depends_on:
      - consul-config
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      CONSUL_GRPC_ADDR: http://consul:8502
      CONSUL_DATACENTER: ${CONSUL_DATACENTER:-dc1}
      SERVICE_ID: itch-feed-${CONSUL_DATACENTER}
      ENVOY_ADMIN_BIND: 0.0.0.0:29003
    volumes:
      - itch-feed-envoy-bootstrap:/bootstrap
    command:
      - sh
      - -ec
      - |
        echo "Waiting for Consul..."
        for i in $(seq 1 90); do consul info >/dev/null 2>&1 && break; sleep 1; done
        echo "Waiting for service registration (${SERVICE_ID})..."
        for i in $(seq 1 180); do wget -qO- "http://consul:8500/v1/agent/service/${SERVICE_ID}" >/dev/null 2>&1 && break; sleep 1; done
        echo "Generating Envoy bootstrap for ${SERVICE_ID}..."
        consul connect envoy -sidecar-for "${SERVICE_ID}" -admin-bind "${ENVOY_ADMIN_BIND}" -bootstrap >/bootstrap/bootstrap.json

  itch-feed-envoy:
    image: ${ENVOY_IMAGE:-docker.io/envoyproxy/envoy:v1.29-latest}
    depends_on:
      - itch-feed-envoy-bootstrap
    restart: unless-stopped
    volumes:
      - itch-feed-envoy-bootstrap:/bootstrap:ro
    command:
      - sh
      - -ec
      - |
        echo "Waiting for bootstrap..."
        for i in $(seq 1 120); do [ -s /bootstrap/bootstrap.json ] && break; sleep 1; done
        test -s /bootstrap/bootstrap.json
        exec envoy -c /bootstrap/bootstrap.json ${ENVOY_EXTRA_ARGS:-}
    ports:
      - "21003:21003"
      - "127.0.0.1:29003:29003"
    networks: [mesh]

volumes:
  consul-data:
  mesh-gateway-bootstrap:
  webservice-envoy-bootstrap:
  ordermanager-envoy-bootstrap:
  refdata-envoy-bootstrap:
  itch-feed-envoy-bootstrap:

networks:
  mesh:
